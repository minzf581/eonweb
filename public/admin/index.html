<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-zh="管理后台 - EON Protocol" data-en="Admin Dashboard - EON Protocol">管理后台 - EON Protocol</title>
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #0D43F9;
            --secondary-color: #4AD8FD;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --bg-color: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-color: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
        }

        .layout { display: flex; min-height: 100vh; }

        .sidebar {
            width: 260px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 0.5rem; }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-color);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-link i { width: 20px; text-align: center; }

        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title { font-size: 1.75rem; font-weight: 600; }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info span { color: var(--text-secondary); }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #0939d4; }
        .btn-secondary { background: var(--border-color); color: var(--text-color); }
        .btn-danger { background: var(--danger-color); color: white; }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-card .icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .stat-card .icon.blue { background: #EBF5FF; color: var(--primary-color); }
        .stat-card .icon.green { background: #D1FAE5; color: var(--success-color); }
        .stat-card .icon.yellow { background: #FEF3C7; color: var(--warning-color); }
        .stat-card .icon.red { background: #FEE2E2; color: var(--danger-color); }
        .stat-card .icon.purple { background: #EDE9FE; color: #7C3AED; }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .stat-card .sub-stats {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
        }

        .stat-card .sub-stats span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-card .sub-stats .pending { color: var(--warning-color); }
        .stat-card .sub-stats .approved { color: var(--success-color); }

        /* 快捷功能卡片 */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            color: inherit;
            transition: all 0.2s;
            display: block;
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .action-card .header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .action-card .header .icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .action-card .header h3 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .action-card p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .action-card .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 1rem;
        }

        .action-card .badge.pending {
            background: #FEF3C7;
            color: #92400E;
        }

        /* 最近活动 */
        .recent-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .recent-section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item .icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .activity-item .content {
            flex: 1;
        }

        .activity-item .content .title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .activity-item .content .time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -260px;
                z-index: 1000;
                transition: left 0.3s;
            }

            .sidebar.open { left: 0; }

            .main-content { margin-left: 0; }

            .menu-toggle {
                display: block;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 999;
                background: var(--primary-color);
                color: white;
                border: none;
                padding: 0.75rem;
                border-radius: 8px;
                cursor: pointer;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <span>EON Protocol</span>
        </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin/" class="nav-link active">
                        <i class="fas fa-home"></i>
                        <span data-zh="仪表盘" data-en="Dashboard">仪表盘</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/fundraising.html" class="nav-link">
                        <i class="fas fa-building"></i>
                        <span data-zh="企业管理" data-en="Companies">企业管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/fundraising.html#investors" class="nav-link">
                        <i class="fas fa-user-tie"></i>
                        <span data-zh="投资人管理" data-en="Investors">投资人管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/fundraising.html#users" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span data-zh="用户管理" data-en="Users">用户管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/fundraising.html#messages" class="nav-link">
                        <i class="fas fa-envelope"></i>
                        <span data-zh="消息中心" data-en="Messages">消息中心</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/fundraising.html#requests" class="nav-link">
                        <i class="fas fa-clipboard-list"></i>
                        <span data-zh="访问请求" data-en="Requests">访问请求</span>
                    </a>
                </li>
                <li class="nav-item" style="margin-top: 2rem;">
                    <a href="/" class="nav-link">
                        <i class="fas fa-arrow-left"></i>
                        <span data-zh="返回首页" data-en="Back to Home">返回首页</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-zh="退出登录" data-en="Logout">退出登录</span>
                    </a>
                </li>
                <li class="nav-item" style="margin-top: 1rem;">
                    <button class="lang-switch nav-link" data-lang-switch style="width: 100%; text-align: left; background: none; border: none; cursor: pointer;">
                        <i class="fas fa-globe"></i>
                        <span>EN</span>
                    </button>
                </li>
            </ul>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title" data-zh="管理后台" data-en="Admin Dashboard">管理后台</h1>
                <div class="user-info">
                    <span id="adminEmail" data-zh="管理员" data-en="Admin">管理员</span>
                    <button class="btn btn-secondary" onclick="openChangePasswordModal()">
                        <i class="fas fa-key"></i> <span data-zh="修改密码" data-en="Change Password">修改密码</span>
                    </button>
                </div>
            </div>

            <!-- 统计卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon blue"><i class="fas fa-building"></i></div>
                    <div class="value" id="totalCompanies">-</div>
                    <div class="label" data-zh="企业总数" data-en="Total Companies">企业总数</div>
                    <div class="sub-stats">
                        <span class="pending"><i class="fas fa-clock"></i> <span data-zh="待审核" data-en="Pending">待审核</span>: <b id="pendingCompanies">-</b></span>
                        <span class="approved"><i class="fas fa-check"></i> <span data-zh="已通过" data-en="Approved">已通过</span>: <b id="approvedCompanies">-</b></span>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="icon green"><i class="fas fa-user-tie"></i></div>
                    <div class="value" id="totalInvestors">-</div>
                    <div class="label" data-zh="投资人总数" data-en="Total Investors">投资人总数</div>
                    <div class="sub-stats">
                        <span class="pending"><i class="fas fa-clock"></i> <span data-zh="待审核" data-en="Pending">待审核</span>: <b id="pendingInvestors">-</b></span>
                        <span class="approved"><i class="fas fa-check"></i> <span data-zh="已通过" data-en="Approved">已通过</span>: <b id="approvedInvestors">-</b></span>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="icon yellow"><i class="fas fa-clipboard-list"></i></div>
                    <div class="value" id="pendingRequests">-</div>
                    <div class="label" data-zh="待处理请求" data-en="Pending Requests">待处理请求</div>
                    <div class="sub-stats">
                        <span><i class="fas fa-inbox"></i> <span data-zh="总请求" data-en="Total">总请求</span>: <b id="totalRequests">-</b></span>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="icon purple"><i class="fas fa-users"></i></div>
                    <div class="value" id="totalUsers">-</div>
                    <div class="label" data-zh="用户总数" data-en="Total Users">用户总数</div>
                    <div class="sub-stats">
                        <span><i class="fas fa-envelope"></i> <span data-zh="邮件服务" data-en="Email">邮件服务</span>: <b id="emailStatus">-</b></span>
                    </div>
                </div>
            </div>

            <!-- 快捷功能 -->
            <h2 style="margin-bottom: 1rem;" data-zh="快捷功能" data-en="Quick Actions">快捷功能</h2>
            <div class="quick-actions">
                <a href="/admin/fundraising.html" class="action-card">
                    <div class="header">
                        <div class="icon" style="background: #EBF5FF; color: var(--primary-color);">
                            <i class="fas fa-building"></i>
                        </div>
                        <h3 data-zh="企业审核" data-en="Company Review">企业审核</h3>
                    </div>
                    <p data-zh="审核企业提交的资料、BP文件，管理企业状态和可见性设置。" data-en="Review company submissions, BP files, manage status and visibility.">审核企业提交的资料、BP文件，管理企业状态和可见性设置。</p>
                    <span class="badge pending" id="companyBadge">0 <span data-zh="待审核" data-en="Pending">待审核</span></span>
                </a>

                <a href="/admin/fundraising.html#investors" class="action-card">
                    <div class="header">
                        <div class="icon" style="background: #D1FAE5; color: var(--success-color);">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <h3 data-zh="投资人审核" data-en="Investor Review">投资人审核</h3>
                    </div>
                    <p data-zh="审核投资人注册申请，管理投资人账户状态。" data-en="Review investor registrations, manage account status.">审核投资人注册申请，管理投资人账户状态。</p>
                    <span class="badge pending" id="investorBadge">0 <span data-zh="待审核" data-en="Pending">待审核</span></span>
                </a>

                <a href="/admin/fundraising.html#requests" class="action-card">
                    <div class="header">
                        <div class="icon" style="background: #FEF3C7; color: var(--warning-color);">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <h3 data-zh="处理请求" data-en="Process Requests">处理请求</h3>
                    </div>
                    <p data-zh="处理投资人的BP访问请求、引荐请求等。" data-en="Process investor BP access requests, introduction requests, etc.">处理投资人的BP访问请求、引荐请求等。</p>
                    <span class="badge pending" id="requestBadge">0 <span data-zh="待处理" data-en="Pending">待处理</span></span>
                </a>

                <a href="/admin/fundraising.html#users" class="action-card">
                    <div class="header">
                        <div class="icon" style="background: #EDE9FE; color: #7C3AED;">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <h3 data-zh="用户管理" data-en="User Management">用户管理</h3>
                    </div>
                    <p data-zh="创建新用户（管理员/企业/投资人），重置密码，管理账户状态。" data-en="Create users (admin/company/investor), reset passwords, manage accounts.">创建新用户（管理员/企业/投资人），重置密码，管理账户状态。</p>
                </a>

                <a href="/admin/fundraising.html#messages" class="action-card">
                    <div class="header">
                        <div class="icon" style="background: #FEE2E2; color: var(--danger-color);">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <h3 data-zh="消息中心" data-en="Message Center">消息中心</h3>
                    </div>
                    <p data-zh="向企业或投资人发送消息，支持附件和邮件通知功能。" data-en="Send messages to companies or investors with attachments and email notifications.">向企业或投资人发送消息，支持附件和邮件通知功能。</p>
                </a>

                <a href="#" class="action-card" onclick="openChangePasswordModal(); return false;">
                    <div class="header">
                        <div class="icon" style="background: #F3F4F6; color: var(--text-secondary);">
                            <i class="fas fa-key"></i>
                        </div>
                        <h3 data-zh="修改密码" data-en="Change Password">修改密码</h3>
                    </div>
                    <p data-zh="修改管理员账户密码，保护账户安全。" data-en="Change admin password to protect account security.">修改管理员账户密码，保护账户安全。</p>
                </a>
        </div>

            <!-- 最近活动 -->
            <div class="recent-section">
                <h2 data-zh="最近企业" data-en="Recent Companies">最近企业</h2>
                <ul class="activity-list" id="recentCompanies">
                    <li class="loading"><i class="fas fa-spinner fa-spin"></i> <span data-zh="加载中..." data-en="Loading...">加载中...</span></li>
                </ul>
            </div>
        </main>
    </div>

    <!-- 修改密码模态框 -->
    <div class="modal" id="changePasswordModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 400px; width: 90%;">
            <h2 style="margin-bottom: 1.5rem;" data-zh="修改密码" data-en="Change Password">修改密码</h2>
            <form id="changePasswordForm">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;" data-zh="当前密码" data-en="Current Password">当前密码</label>
                    <input type="password" id="currentPassword" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;" data-zh="新密码" data-en="New Password">新密码</label>
                    <input type="password" id="newPassword" required minlength="6" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;" data-zh="确认新密码" data-en="Confirm Password">确认新密码</label>
                    <input type="password" id="confirmPassword" required minlength="6" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;" data-zh="保存" data-en="Save">保存</button>
                    <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()" style="flex: 1;" data-zh="取消" data-en="Cancel">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/lang.js"></script>
    <script>
        let token = localStorage.getItem('token');

        // 多语言文本
        const i18n = {
            pending: { zh: '待审核', en: 'Pending' },
            approved: { zh: '已通过', en: 'Approved' },
            rejected: { zh: '已拒绝', en: 'Rejected' },
            draft: { zh: '草稿', en: 'Draft' },
            pendingProcess: { zh: '待处理', en: 'Pending' },
            noCompanyData: { zh: '暂无企业数据', en: 'No company data' },
            loadFailed: { zh: '加载失败', en: 'Load failed' },
            unnamed: { zh: '未命名企业', en: 'Unnamed Company' },
            noIndustry: { zh: '未设置行业', en: 'No industry' },
            view: { zh: '查看', en: 'View' },
            configured: { zh: '已配置', en: 'Configured' },
            notConfigured: { zh: '未配置', en: 'Not Configured' },
            unknown: { zh: '未知', en: 'Unknown' },
            passwordMismatch: { zh: '两次输入的新密码不一致', en: 'New passwords do not match' },
            passwordTooShort: { zh: '新密码长度至少6位', en: 'New password must be at least 6 characters' },
            passwordChanged: { zh: '密码修改成功！', en: 'Password changed successfully!' },
            changeFailed: { zh: '修改失败', en: 'Change failed' },
            noAdminAccess: { zh: '您没有管理员权限', en: 'You do not have admin access' },
            authFailed: { zh: '认证失败', en: 'Authentication failed' }
        };

        function t(key) {
            const lang = localStorage.getItem('eon_language') || 'zh';
            return i18n[key] ? (i18n[key][lang] || i18n[key].zh) : key;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (!token) {
                window.location.href = '/auth/login.html?redirect=/admin/';
                return;
            }

            // 验证管理员权限
            const user = await checkAdmin();
            if (!user) return;

            // 显示管理员邮箱
            document.getElementById('adminEmail').textContent = user.email;

            // 加载统计数据
            loadStats();
            loadRecentCompanies();
            checkEmailStatus();
        });

        // 监听语言变化重新加载数据
        window.addEventListener('languageChanged', () => {
            loadStats();
            loadRecentCompanies();
            checkEmailStatus();
        });

        async function checkAdmin() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error(t('authFailed'));

                const data = await response.json();
                
                if (data.user.role !== 'admin') {
                    alert(t('noAdminAccess'));
                    window.location.href = '/';
                    return null;
                }
                return data.user;
            } catch (error) {
                console.error(t('authFailed') + ':', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/auth/login.html';
                return null;
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                // 企业统计
                document.getElementById('totalCompanies').textContent = data.companies?.total || 0;
                document.getElementById('pendingCompanies').textContent = data.companies?.pending || 0;
                document.getElementById('approvedCompanies').textContent = data.companies?.approved || 0;
                const companyBadge = document.getElementById('companyBadge');
                companyBadge.innerHTML = `${data.companies?.pending || 0} <span data-zh="待审核" data-en="Pending">${t('pending')}</span>`;

                // 投资人统计
                document.getElementById('totalInvestors').textContent = data.investors?.total || 0;
                document.getElementById('pendingInvestors').textContent = data.investors?.pending || 0;
                document.getElementById('approvedInvestors').textContent = data.investors?.approved || 0;
                const investorBadge = document.getElementById('investorBadge');
                investorBadge.innerHTML = `${data.investors?.pending || 0} <span data-zh="待审核" data-en="Pending">${t('pending')}</span>`;

                // 请求统计
                document.getElementById('pendingRequests').textContent = data.requests?.pending || 0;
                document.getElementById('totalRequests').textContent = data.requests?.total || 0;
                const requestBadge = document.getElementById('requestBadge');
                requestBadge.innerHTML = `${data.requests?.pending || 0} <span data-zh="待处理" data-en="Pending">${t('pendingProcess')}</span>`;

                // 用户总数
                document.getElementById('totalUsers').textContent = 
                    (data.companies?.total || 0) + (data.investors?.total || 0);

            } catch (error) {
                console.error('Load stats failed:', error);
            }
        }

        async function loadRecentCompanies() {
            try {
                const response = await fetch('/api/admin/companies?limit=5', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                const container = document.getElementById('recentCompanies');
                
                if (!data.companies || data.companies.length === 0) {
                    container.innerHTML = `<li class="empty-state">${t('noCompanyData')}</li>`;
                    return;
                }

                container.innerHTML = data.companies.map(c => {
                    const statusColors = {
                        pending: '#F59E0B',
                        approved: '#10B981',
                        rejected: '#EF4444',
                        draft: '#6B7280'
                    };
                    const statusLabel = t(c.status) || c.status;
                    return `
                        <li class="activity-item">
                            <div class="icon" style="background: #EBF5FF; color: var(--primary-color);">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="content">
                                <div class="title">${c.name_cn || c.name_en || t('unnamed')}</div>
                                <div class="time">
                                    <span style="color: ${statusColors[c.status] || '#6B7280'};">● ${statusLabel}</span>
                                    · ${c.industry_primary || t('noIndustry')}
                                    · ${new Date(c.created_at).toLocaleDateString()}
                                </div>
                            </div>
                            <a href="/admin/fundraising.html" class="btn btn-secondary" style="font-size: 0.75rem;">
                                ${t('view')}
                            </a>
                        </li>
                    `;
                }).join('');
            } catch (error) {
                console.error('Load companies failed:', error);
                document.getElementById('recentCompanies').innerHTML = 
                    `<li class="empty-state">${t('loadFailed')}</li>`;
            }
        }

        async function checkEmailStatus() {
            try {
                const response = await fetch('/api/admin/email-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                document.getElementById('emailStatus').textContent = data.configured ? t('configured') : t('notConfigured');
            } catch (error) {
                document.getElementById('emailStatus').textContent = t('unknown');
            }
        }

        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('changePasswordForm').reset();
        }

        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert(t('passwordMismatch'));
                return;
            }

            if (newPassword.length < 6) {
                alert(t('passwordTooShort'));
                return;
            }

            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || t('changeFailed'));
                }

                alert(t('passwordChanged'));
                closeChangePasswordModal();
            } catch (error) {
                alert(error.message);
            }
        });

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // 点击模态框外部关闭
        document.getElementById('changePasswordModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeChangePasswordModal();
            }
        });
    </script>
    <script src="/static/js/lang.js"></script>
</body>
</html>
