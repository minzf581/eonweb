# EON Protocol 融资平台部署指南

## 项目结构

```
eonweb/
├── config/
│   └── database.js          # 数据库配置
├── models/
│   ├── index.js             # 模型索引和关联
│   ├── User.js              # 用户模型
│   ├── Company.js           # 企业模型
│   ├── FundraisingInfo.js   # 融资信息模型
│   ├── Document.js          # 文档模型
│   ├── InvestorProfile.js   # 投资人资料模型
│   ├── AccessRequest.js     # 访问请求模型
│   └── Message.js           # 消息模型（管理员消息系统）
├── routes/
│   ├── auth.js              # 认证路由
│   ├── company.js           # 企业路由
│   ├── investor.js          # 投资人路由
│   └── admin.js             # 管理后台路由
├── middleware/
│   └── auth.js              # 认证中间件
├── public/
│   ├── company/
│   │   └── index.html       # 企业门户
│   ├── investor/
│   │   └── index.html       # 投资人门户
│   ├── admin/
│   │   └── fundraising.html # 融资平台管理后台
│   └── auth/
│       ├── login.html       # 登录页面
│       └── register.html    # 注册页面
├── scripts/
│   └── init-db.js           # 数据库初始化脚本
└── uploads/                 # 上传文件目录
```

## 部署到 Railway

### 1. 创建 PostgreSQL 数据库

在 Railway 控制台：
1. 点击 "New" -> "Database" -> "PostgreSQL"
2. 等待数据库创建完成
3. 复制 `DATABASE_URL` 连接字符串

### 2. 配置环境变量

在 Railway 项目设置中添加以下环境变量：

#### 必需变量
```
DATABASE_URL=postgresql://... (从 PostgreSQL 服务复制)
JWT_SECRET=your-super-secret-key-change-this
ADMIN_EMAIL=admin@eon-protocol.com
ADMIN_PASSWORD=your-secure-password
NODE_ENV=production
```

#### 可选变量（邮件服务）
```
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-smtp-user
SMTP_PASS=your-smtp-password
SMTP_FROM=noreply@eon-protocol.com
SMTP_SECURE=false
```

### 3. 部署应用

方式一：通过 GitHub 连接
1. 将代码推送到 GitHub
2. 在 Railway 中连接 GitHub 仓库
3. 选择分支并部署

方式二：通过 Railway CLI
```bash
# 安装 Railway CLI
npm install -g @railway/cli

# 登录
railway login

# 连接项目
railway link

# 部署
railway up
```

### 4. 初始化数据库

部署成功后，运行初始化脚本：

```bash
# 通过 Railway CLI 运行
railway run npm run init-db
```

或者在 Railway 控制台的 Shell 中运行：
```bash
npm run init-db
```

## 访问入口

部署完成后，可以通过以下路径访问：

- **企业门户**: `https://your-domain.railway.app/company`
- **投资人门户**: `https://your-domain.railway.app/investor`
- **管理后台**: `https://your-domain.railway.app/admin/fundraising.html`
- **注册页面**: `https://your-domain.railway.app/auth/register.html`
- **登录页面**: `https://your-domain.railway.app/auth/login.html`

## 默认管理员账户

系统启动时会自动创建默认管理员账户：
- **邮箱**: `ADMIN_EMAIL` 环境变量值（默认：admin@eonprotocol.com）
- **密码**: `ADMIN_PASSWORD` 环境变量值（默认：admin123456）

⚠️ **重要**: 首次登录后请立即在管理后台修改密码！

## API 端点

### 认证 API
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/me` - 获取当前用户信息

### 企业 API
- `GET /api/company/profile` - 获取企业资料
- `POST /api/company/profile` - 创建/更新企业资料
- `POST /api/company/fundraising` - 保存融资信息
- `POST /api/company/upload-bp` - 上传 BP 文件
- `GET /api/company/documents` - 获取文档列表
- `GET /api/company/documents/:id/download` - 下载文档
- `DELETE /api/company/documents/:id` - 删除文档
- `POST /api/company/submit` - 提交审核

### 投资人 API
- `GET /api/investor/profile` - 获取投资人资料
- `POST /api/investor/profile` - 保存投资人资料
- `GET /api/investor/projects` - 浏览项目列表
- `GET /api/investor/projects/:id` - 获取项目详情
- `POST /api/investor/request-access` - 请求访问权限

### 管理后台 API

#### 统计与列表
- `GET /api/admin/stats` - 获取统计数据
- `GET /api/admin/companies` - 企业列表
- `GET /api/admin/companies/:id` - 企业详情
- `GET /api/admin/investors` - 投资人列表
- `GET /api/admin/requests` - 访问请求列表
- `GET /api/admin/users` - 用户列表

#### 审核操作
- `PUT /api/admin/companies/:id/review` - 审核企业
- `PUT /api/admin/investors/:id/review` - 审核投资人
- `PUT /api/admin/requests/:id` - 处理请求

#### 用户管理（新增）
- `POST /api/admin/users` - 创建用户（管理员/企业/投资人）
- `PUT /api/admin/users/:id` - 更新用户状态/角色
- `DELETE /api/admin/users/:id` - 删除用户
- `PUT /api/admin/users/:id/reset-password` - 重置用户密码
- `PUT /api/admin/change-password` - 修改自己的密码

#### 消息系统（新增）
- `POST /api/admin/messages` - 发送消息（支持附件和邮件）
- `GET /api/admin/messages` - 获取所有消息
- `GET /api/admin/messages/sent` - 获取已发送消息
- `GET /api/admin/messages/:id` - 消息详情
- `GET /api/admin/messages/:id/attachments/:index` - 下载消息附件
- `GET /api/admin/email-status` - 获取邮件配置状态

## 管理员功能说明

### 1. 用户管理
管理员可以：
- 创建新用户（管理员/企业/投资人账户）
- 重置任意用户的密码
- 删除用户账户
- 修改用户状态和角色

### 2. 消息系统
管理员可以向企业或投资人发送消息：
- 支持添加多个附件（每个最大10MB）
- 可选择是否同时发送邮件通知
- 发送消息时可以直接变更企业/投资人状态

### 3. 审核功能
- 审核企业提交的资料
- 审核投资人注册申请
- 处理投资人的访问请求

### 4. 密码管理
- 管理员可以在系统设置中修改自己的密码
- 可以重置任意用户的密码

## 角色权限

| 角色 | 权限 |
|------|------|
| company | 企业用户，可以提交企业信息和融资需求 |
| investor | 投资人，可以浏览项目和请求引荐 |
| admin | 管理员，可以审核企业、投资人、发送消息、管理用户 |

## 数据模型

### 用户 (User)
- 支持三种角色：company, investor, admin
- 密码使用 bcrypt 加密存储
- 状态：pending, active, suspended

### 企业 (Company)
- 包含基本信息、行业、阶段、联系人等
- 状态：draft, pending, approved, rejected
- 可见性：private, investors, whitelist

### 融资信息 (FundraisingInfo)
- 关联企业
- 包含融资目的、类型、金额、时间窗口等

### 文档 (Document)
- 支持 BP、财务、法律等类型文件
- 文件内容存储在数据库中（Base64编码）
- 支持访问控制

### 投资人资料 (InvestorProfile)
- 包含投资人信息和投资偏好
- 需要管理员审核后才能浏览项目

### 访问请求 (AccessRequest)
- 投资人向企业发起的 BP 访问或引荐请求
- 由管理员处理

### 消息 (Message) - 新增
- 管理员发送给用户的消息
- 支持附件（存储为Base64）
- 记录邮件发送状态
- 可关联状态变更操作

## 邮件服务配置

要启用邮件发送功能，需要配置 SMTP 环境变量：

```
SMTP_HOST=smtp.gmail.com      # Gmail 示例
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password   # Gmail 需要使用应用专用密码
SMTP_FROM=EON Protocol <noreply@eon-protocol.com>
SMTP_SECURE=false             # 如果使用 465 端口，设置为 true
```

常用 SMTP 服务：
- Gmail: smtp.gmail.com (端口 587)
- SendGrid: smtp.sendgrid.net (端口 587)
- AWS SES: email-smtp.{region}.amazonaws.com
- 阿里云邮件: smtpdm.aliyun.com

## 安全注意事项

1. **修改默认管理员密码** - 首次登录后立即修改
2. **设置强 JWT_SECRET** - 使用随机生成的长字符串
3. **启用 HTTPS** - Railway 默认提供 HTTPS
4. **定期备份数据库** - 在 Railway 控制台设置自动备份
5. **监控异常登录行为** - 检查日志中的异常登录尝试
6. **保护 SMTP 凭据** - 不要在代码中硬编码邮件密码

## 故障排除

### 数据库连接失败
- 检查 `DATABASE_URL` 环境变量是否正确
- 确认 PostgreSQL 服务正在运行

### 邮件发送失败
- 检查 SMTP 配置是否正确
- Gmail 用户需要启用"低安全性应用访问"或使用应用专用密码
- 检查防火墙是否允许 SMTP 端口

### 文件上传失败
- 确保文件大小不超过 10MB
- 检查文件格式是否支持（PDF, PPT, PPTX, DOC, DOCX）

### 登录问题
- 清除浏览器缓存和 localStorage
- 检查 JWT_SECRET 是否正确配置
