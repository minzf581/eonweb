# EON Protocol 融资平台部署指南

## 项目结构

```
eonweb/
├── config/
│   └── database.js          # 数据库配置
├── models/
│   ├── index.js             # 模型索引和关联
│   ├── User.js              # 用户模型
│   ├── Company.js           # 企业模型
│   ├── FundraisingInfo.js   # 融资信息模型
│   ├── Document.js          # 文档模型
│   ├── InvestorProfile.js   # 投资人资料模型
│   ├── AccessRequest.js     # 访问请求模型
│   └── Message.js           # 消息模型（管理员消息系统）
├── routes/
│   ├── auth.js              # 认证路由
│   ├── company.js           # 企业路由
│   ├── investor.js          # 投资人路由
│   └── admin.js             # 管理后台路由
├── middleware/
│   └── auth.js              # 认证中间件
├── public/
│   ├── company/
│   │   └── index.html       # 企业门户
│   ├── investor/
│   │   └── index.html       # 投资人门户
│   ├── admin/
│   │   └── fundraising.html # 融资平台管理后台
│   └── auth/
│       ├── login.html       # 登录页面
│       └── register.html    # 注册页面
├── scripts/
│   └── init-db.js           # 数据库初始化脚本
└── uploads/                 # 上传文件目录
```

## 部署到 Railway

数据库url： postgresql://postgres:VmPQYyympykEtaHihWGKyaslZSGhjMJu@trolley.proxy.rlwy.net:42525/railway

### 2. 配置环境变量

在 Railway 项目设置中添加以下环境变量：

#### 必需变量
```
DATABASE_URL=postgresql://... (从 PostgreSQL 服务复制)
JWT_SECRET=your-super-secret-key-change-this
ADMIN_EMAIL=admin@eon-protocol.com
ADMIN_PASSWORD=your-secure-password
NODE_ENV=production
```

#### 可选变量（邮件服务 - 二选一）

**方式一：Resend（推荐）**
```
RESEND_API_KEY=re_xxxxxxxxxxxx
EMAIL_FROM=EON Protocol <noreply@eon-protocol.com>
```

**方式二：SMTP**
```
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-smtp-user
SMTP_PASS=your-smtp-password
SMTP_FROM=noreply@eon-protocol.com
SMTP_SECURE=false
```

### 3. 部署应用

方式一：通过 GitHub 连接
1. 将代码推送到 GitHub
2. 在 Railway 中连接 GitHub 仓库
3. 选择分支并部署

方式二：通过 Railway CLI
```bash
# 安装 Railway CLI
npm install -g @railway/cli

# 登录
railway login

# 连接项目
railway link

# 部署
railway up
```

### 4. 初始化数据库

部署成功后，运行初始化脚本：

```bash
# 通过 Railway CLI 运行
railway run npm run init-db
```

或者在 Railway 控制台的 Shell 中运行：
```bash
npm run init-db
```

## 访问入口

部署完成后，可以通过以下路径访问：

- **企业门户**: `https://your-domain.railway.app/company` （统一入口，支持 company 和 staff 角色）
- **运营管理门户**: `https://your-domain.railway.app/staff` （自动重定向到 `/company`）
- **投资人门户**: `https://your-domain.railway.app/investor`
- **超级管理后台**: `https://your-domain.railway.app/admin/`
- **管理后台详情**: `https://your-domain.railway.app/admin/fundraising.html`
- **注册页面**: `https://your-domain.railway.app/auth/register.html`
- **登录页面**: `https://your-domain.railway.app/auth/login.html`

### 超级管理后台导航

超级管理员登录后会进入管理后台首页 (`/admin/`)，显示：
- 统计概览（企业、投资人、请求、用户数量）
- 快捷功能入口
- 最近企业列表

点击各功能模块会跳转到 `/admin/fundraising.html` 并自动切换到对应标签页：
- 企业管理: `/admin/fundraising.html#companies`
- 投资人管理: `/admin/fundraising.html#investors`
- 访问请求: `/admin/fundraising.html#requests`
- 用户管理: `/admin/fundraising.html#users`
- 消息中心: `/admin/fundraising.html#messages`
- 系统设置: `/admin/fundraising.html#settings`

## 默认管理员账户

系统在**每次启动时**会自动检查并创建/更新管理员账户：

- **邮箱**: `ADMIN_EMAIL` 环境变量值（默认：admin@eonprotocol.com）
- **密码**: `ADMIN_PASSWORD` 环境变量值（默认：admin123456）

### 自动同步机制
- 如果管理员账户不存在，系统会自动创建
- 如果 `ADMIN_PASSWORD` 环境变量已设置，系统会在启动时验证密码
- 如果密码不匹配，系统会自动更新为环境变量中的密码
- 可以通过修改环境变量 `ADMIN_PASSWORD` 来重置密码（需重启应用）

⚠️ **重要**: 
1. 建议使用强密码（至少12位，包含大小写字母、数字和特殊字符）
2. 首次登录后请立即在管理后台修改密码！
3. 修改 `ADMIN_PASSWORD` 环境变量后，需要重启应用才会生效

## API 端点

### 认证 API
- `POST /api/auth/register` - 用户注册（支持推荐码）
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/me` - 获取当前用户信息
- `POST /api/auth/change-password` - 修改密码
- `POST /api/auth/reset-password` - 请求密码重置（发送临时密码）
- `POST /api/auth/force-change-password` - 强制修改密码（临时密码登录后）

### 推荐码 API
- `GET /api/auth/referral` - 获取我的推荐码和推荐链接
- `GET /api/auth/referral/validate/:code` - 验证推荐码是否有效
- `GET /api/auth/referrer` - 获取我的推荐人信息

### 企业 API
- `GET /api/company/profile` - 获取企业资料
- `POST /api/company/profile` - 创建/更新企业资料
- `POST /api/company/fundraising` - 保存融资信息
- `POST /api/company/upload-bp` - 上传 BP 文件
- `POST /api/company/bp-link` - 保存 BP 外部链接
- `GET /api/company/documents` - 获取文档列表
- `GET /api/company/documents/:id/download` - 下载文档
- `DELETE /api/company/documents/:id` - 删除文档
- `POST /api/company/submit` - 提交审核

### 投资人 API
- `GET /api/investor/profile` - 获取投资人资料
- `POST /api/investor/profile` - 保存投资人资料
- `GET /api/investor/projects` - 浏览项目列表
- `GET /api/investor/projects/:id` - 获取项目详情
- `POST /api/investor/request-access` - 请求访问权限
- `GET /api/investor/my-requests` - 获取我的请求记录

### 管理后台 API

#### 统计与列表
- `GET /api/admin/stats` - 获取统计数据
- `GET /api/admin/companies` - 企业列表
- `GET /api/admin/companies/:id` - 企业详情
- `GET /api/admin/investors` - 投资人列表
- `GET /api/admin/requests` - 访问请求列表
- `GET /api/admin/users` - 用户列表

#### 审核操作
- `PUT /api/admin/companies/:id/review` - 审核企业
- `PUT /api/admin/investors/:id/review` - 审核投资人
- `PUT /api/admin/requests/:id` - 处理请求

#### 用户管理（新增）
- `POST /api/admin/users` - 创建用户（管理员/企业/投资人）
- `PUT /api/admin/users/:id` - 更新用户状态/角色
- `DELETE /api/admin/users/:id` - 删除用户
- `PUT /api/admin/users/:id/reset-password` - 重置用户密码
- `PUT /api/admin/change-password` - 修改自己的密码

#### 消息系统（新增）
- `POST /api/admin/messages` - 发送消息（支持附件和邮件）
- `GET /api/admin/messages` - 获取所有消息
- `GET /api/admin/messages/sent` - 获取已发送消息
- `GET /api/admin/messages/:id` - 消息详情
- `GET /api/admin/messages/:id/attachments/:index` - 下载消息附件
- `GET /api/admin/email-status` - 获取邮件配置状态

## 管理员功能说明

### 1. 用户管理
管理员可以：
- 创建新用户（管理员/企业/投资人账户）
- 重置任意用户的密码
- 删除用户账户
- 修改用户状态和角色

### 2. 消息系统
管理员可以向企业或投资人发送消息：
- 支持添加多个附件（每个最大10MB）
- 可选择是否同时发送邮件通知
- 发送消息时可以直接变更企业/投资人状态

### 3. 审核功能
- 审核企业提交的资料
- 审核投资人注册申请
- 处理投资人的访问请求

### 4. 密码管理
- 管理员可以在系统设置中修改自己的密码
- 可以重置任意用户的密码

### 4.1 用户密码重置功能（新增）
用户忘记密码时可以通过邮箱重置：

#### 重置流程
1. 用户在登录页面点击"忘记密码"
2. 输入注册邮箱地址
3. 系统生成10位临时密码并发送到邮箱
4. 用户使用临时密码登录
5. 系统强制要求设置新密码
6. 设置完成后使用新密码登录

#### 技术细节
- 临时密码有效期：**24小时**
- 临时密码格式：10位字母数字组合（排除易混淆字符）
- 使用临时密码登录后会弹出强制修改密码窗口
- 密码长度要求：至少6位

#### 邮件模板
系统会发送包含以下内容的邮件：
- 临时密码（醒目显示）
- 有效期提示（24小时）
- 登录后需要设置新密码的说明
- 安全提示（如果不是本人操作请忽略）

### 5. 文档管理
- 查看企业上传的 BP 文件和其他文档
- 预览和下载文档（支持 PDF、PPT、DOC 等格式）
- 查看文档下载统计

### 6. 反馈交流系统
管理员和Staff可以通过企业详情页与企业进行反馈交流：

#### 内部评论（仅内部可见）
- **红色区域**标识，明确提示"仅管理员和Staff可见，企业无法看到"
- 用于记录内部讨论、备注、评估意见等敏感信息
- 企业端完全不可见，保证内部沟通的私密性
- 发送时自动邮件通知所有管理员和有权限的Staff

#### 给企业的反馈（企业可见）
- **绿色区域**标识，明确提示"以下内容企业可以看到"
- 用于与企业进行正式沟通、提供审核意见、请求补充资料等
- 企业可以在自己的门户中查看并回复
- 发送时自动邮件通知企业、所有管理员和有权限的Staff

#### 评论管理
- 管理员可以删除任何评论
- Staff 只能删除自己发送的评论
- 每条评论右侧有删除按钮（🗑️）

## 企业功能说明

企业用户可以通过企业门户 (`/company`) 管理融资相关信息：

### 0. 访问控制（新功能）
企业或创建企业的Staff可以控制谁可以看到自己公司的信息，访问控制分为四级：

#### 可见性级别
1. **私有 (Private)** - 🔒 红色
   - 仅您自己可见
   - 任何投资人都无法看到您的企业信息
   - 适用于：还在整理资料，暂不想对外展示

2. **仅管理员 (Admin Only)** - 🛡️ 黄色
   - 仅 EON Protocol 管理员可见
   - 投资人无法看到
   - 适用于：希望先由 EON Protocol 团队评估

3. **部分公开 (Partial)** - 🔐 蓝色
   - 投资人可以看到基本公司信息
   - BP 和资料库需要申请审批后才能查看
   - 适用于：希望筛选真正感兴趣的投资人

4. **完全公开 (Public)** - 🌐 绿色
   - 投资人可以看到公司信息和 BP
   - 资料库仍需申请审批（管理员可直接查看）
   - 适用于：开放式融资，广泛接触投资人

#### 访问请求审批
当可见性设置为"部分公开"或"完全公开"时：
- 投资人可以申请访问 BP 或资料库
- 企业/Staff 会收到申请通知
- 在"访问控制"面板中可以批准或拒绝请求
- 批准/拒绝后会自动邮件通知投资人

### 1. 企业资料管理
- **基本信息**：
  - 公司中英文名称
  - 行业分类（主行业、次行业）
  - 融资阶段（种子轮、天使轮、A轮、B轮、C轮、Pre-IPO、IPO、Post-IPO）
  - 总部位置、研发中心位置
  - 公司简介和详细描述
  - 网站、LinkedIn 等链接

- **联系人信息**：
  - 联系人姓名、职位
  - 邮箱、电话
  - 微信、WhatsApp 等联系方式

### 2. 融资信息填写
- **融资需求**：
  - 融资目的（可多选：业务扩张、技术研发、市场拓展、并购等）
  - 融资类型（可多选：股权融资、债权融资、可转债等）
  - 融资金额范围（最小/最大金额，支持多种货币）
  - 融资时间窗口
  - 估值预期
  - 资金用途说明

- **海外结构**：
  - 是否已有新加坡、香港、美国等海外结构
  - 其他海外结构说明

- **知识产权**：
  - IP 所有权情况
  - IP 可转让性
  - IP 相关说明

- **数据敏感性**：
  - 数据敏感性级别
  - 数据敏感性说明

### 3. BP/文档管理
企业可以通过两种方式提交 BP（二选一）：

- **方式一：上传 BP 文件**：
  - 支持格式：PDF、PPT、PPTX、DOC、DOCX
  - 文件大小限制：**2MB**（由于 Railway 平台限制）
  - 实时上传进度显示
  - 支持中文文件名

- **方式二：填写 BP 链接**：
  - 直接输入 BP 文件的公网链接（如 Google Drive、OneDrive、Docsend 等）
  - 适合已有在线 BP 的用户
  - 无需上传即可提交
  - 支持添加描述信息

- **文档管理**：
  - 查看已上传/已提交的 BP 列表
  - 下载已上传的文档或访问外部链接
  - 删除不需要的文档

### 4. 提交审核
- **提交流程**：
  1. 完成企业资料填写
  2. 填写融资信息
  3. 上传 BP 文件**或**填写 BP 链接（二选一）
  4. 点击"提交审核"按钮

- **审核状态**：
  - **草稿 (draft)**：资料未提交，可随时编辑
  - **待审核 (pending)**：已提交，等待管理员审核
  - **ENGAGE**：🤝 跟进讨论 - 管理员决定跟进，对投资人可见
  - **EXPLORE**：🔍 需了解更多 - 需要更多信息来评估
  - **PASS**：⏸️ 暂不跟进 - 管理员决定暂不跟进
  - **已通过 (approved)**：审核通过（旧状态，兼容保留）
  - **已拒绝 (rejected)**：审核未通过（旧状态，兼容保留）

- **可见性设置**（由管理员控制）：
  - **私有 (private)**：仅内部可见
  - **对投资人可见 (investors)**：所有已审核投资人可见（ENGAGE 状态自动设置）
  - **白名单可见 (whitelist)**：仅特定投资人可见

### 5. 查看访问请求
- 查看投资人发起的访问请求
- 了解投资人对项目的关注情况

## 投资人功能说明

投资人用户可以通过投资人门户 (`/investor`) 浏览项目和发起合作：

### 1. 投资人资料管理
- **个人信息**：
  - 姓名、投资人类型（个人/家族办公室/VC/PE/企业战略投资/其他）
  - 所属机构、职位
  - 联系方式（电话、微信、WhatsApp、LinkedIn）

- **投资偏好**：
  - 关注行业（可多选）
  - 投资阶段偏好（可多选）
  - 投资规模范围（最小/最大单笔投资额）
  - 投资区域偏好
  - 个人简介

### 2. 账户审核
- 注册后账户状态为 **待审核 (pending)**
- 需要管理员审核通过后才能浏览项目
- 审核通过后状态变为 **已通过 (approved)**

### 3. 浏览项目
- **项目列表**：
  - 浏览所有已审核通过且对投资人可见的企业项目
  - 支持按行业、阶段、融资金额筛选
  - 分页显示，每页 20 个项目

- **项目详情**：
  - 查看企业基本信息
  - 查看融资需求详情
  - 查看公开文档（如有）
  - 查看项目标签和分类

### 4. 发起访问请求
投资人可以向感兴趣的企业发起以下类型的请求：

- **BP 访问请求**：请求查看企业的商业计划书
- **引荐请求**：请求管理员引荐给企业
- **会议请求**：请求与企业进行会议
- **数据室访问**：请求访问企业数据室

**请求流程**：
1. 在项目详情页点击"请求访问"
2. 选择请求类型
3. 填写请求说明（可选）
4. 提交请求，等待管理员处理

### 5. 查看我的请求
- 查看所有已发起的访问请求
- 查看请求状态：
  - **待处理 (pending)**：等待管理员处理
  - **已批准 (approved)**：请求已批准，可查看更多信息
  - **已拒绝 (rejected)**：请求被拒绝
  - **已过期 (expired)**：请求已过期

- **访问权限**：
  - 请求批准后，可以查看企业的详细联系信息
  - 可以查看更详细的融资信息（资金用途、海外结构等）
  - 可以下载企业的 BP 文件

## 推荐码功能说明

系统支持推荐码功能，任何用户（企业、投资人、管理员）都可以生成自己的推荐码来邀请新用户注册。

### 1. 推荐码生成
- 每个用户自动拥有一个唯一的 8 位推荐码
- 推荐码格式：大写字母和数字组合（排除易混淆字符如 I、O、1、0）
- 通过 API 获取推荐码和推荐链接

### 2. 推荐链接
- 推荐链接格式：`/auth/register.html?ref=推荐码`
- 新用户通过推荐链接访问注册页面时，推荐码会自动填入
- 用户也可以手动输入推荐码

### 3. 推荐优先处理
- 使用推荐码注册的用户会被标记为"优先处理"
- 管理员在审核时可以看到哪些用户是通过推荐注册的
- 推荐用户的审核请求可获得优先处理

### 4. 推荐追踪
- 系统记录每个用户的推荐人（referred_by）
- 系统统计每个用户的推荐数量（referral_count）
- 用户可以查看自己推荐的所有用户列表

### 5. 使用方式
- **获取推荐信息**：调用 `GET /api/auth/referral` 获取推荐码和已推荐用户列表
- **验证推荐码**：调用 `GET /api/auth/referral/validate/:code` 验证推荐码是否有效
- **注册时使用**：在注册表单中填入推荐码，或使用推荐链接直接访问

## 系统功能总结

EON Protocol 融资平台是一个完整的投融资对接系统，主要功能包括：

### 核心功能模块

#### 1. 用户认证与权限管理
- **多角色支持**：企业、投资人、管理员三种角色
- **JWT 认证**：安全的令牌认证机制
- **角色权限控制**：不同角色访问不同功能模块
- **账户状态管理**：pending、active、suspended 等状态
- **推荐码系统**：用户推荐追踪、优先处理标记

#### 2. 企业融资管理
- **完整的企业资料体系**：基本信息、行业分类、融资阶段等
- **详细的融资需求描述**：金额、时间、用途、结构等
- **文档管理系统**：BP 文件上传或外部链接、存储、下载
- **审核工作流**：草稿 → 待审核 → 已通过/已拒绝

#### 3. 投资人项目浏览
- **项目库浏览**：筛选、搜索、分页
- **权限控制**：仅已审核投资人可浏览
- **访问请求机制**：BP 访问、引荐、会议等请求类型
- **分级信息展示**：公开信息 → 请求批准后 → 详细信息

#### 4. 管理员审核系统
- **企业审核**：审核企业资料、融资信息、BP 文件
- **投资人审核**：审核投资人注册申请
- **访问请求处理**：批准/拒绝投资人的访问请求
- **可见性控制**：设置企业项目对投资人的可见性

#### 5. 用户管理
- **账户创建**：管理员可创建各类用户账户
- **密码管理**：重置密码、修改密码
- **状态管理**：激活、暂停、删除账户

#### 6. 消息系统
- **管理员消息**：向企业或投资人发送消息
- **附件支持**：消息可附带文件（Base64 存储）
- **邮件通知**：可选发送邮件通知（需配置 SMTP）
- **状态联动**：发送消息时可同时更新企业/投资人状态

#### 7. 文档管理
- **文件上传**：支持 PDF、PPT、DOC 等格式
- **Base64 存储**：文件内容存储在数据库中（适合 Railway 等无文件系统平台）
- **访问控制**：文档访问权限控制
- **下载统计**：记录文档下载次数

### 技术特点

#### 1. 平台适配
- **Railway 平台优化**：
  - 文件存储在数据库而非文件系统
  - 2MB 文件大小限制（避免请求超时）
  - 内存存储文件上传（避免权限问题）

#### 2. 数据安全
- **密码加密**：bcrypt 哈希存储
- **JWT 令牌**：安全的认证机制
- **权限验证**：每个 API 端点都有权限检查
- **数据脱敏**：投资人浏览时仅显示公开信息

#### 3. 用户体验
- **实时反馈**：上传进度、操作提示
- **响应式设计**：支持桌面和移动端
- **中文支持**：完整的中文界面和文件名支持
- **状态可视化**：清晰的审核状态和进度显示

#### 4. 可扩展性
- **模块化设计**：清晰的路由、模型、中间件分离
- **数据库模型**：使用 Sequelize ORM，易于扩展
- **API 设计**：RESTful API，易于集成

### 业务流程

#### 企业融资流程
1. 注册企业账户
2. 填写企业资料
3. 填写融资信息
4. 上传 BP 文件
5. 提交审核
6. 等待管理员审核
7. 审核通过后对投资人可见
8. 接收投资人的访问请求

#### 投资人浏览流程
1. 注册投资人账户
2. 完善投资人资料
3. 等待管理员审核
4. 审核通过后浏览项目
5. 查看项目详情
6. 发起访问请求（BP 访问/引荐/会议）
7. 等待管理员处理
8. 请求批准后获取更多信息

#### 管理员工作流程
1. 审核企业提交的资料
2. 审核投资人注册申请
3. 处理投资人的访问请求
4. 向企业/投资人发送消息
5. 管理用户账户
6. 监控系统运行状态

## 角色权限

| 角色 | 权限 |
|------|------|
| company | 企业用户，可以提交企业信息和融资需求 |
| investor | 投资人，可以浏览项目和请求引荐 |
| staff | 普通管理员，可以创建多个企业、上传BP、查看投资人对接情况、发送消息 |
| admin | 超级管理员，可以审核企业、投资人、发送消息、管理用户（包括创建普通管理员） |

## 普通管理员（Staff）功能说明

普通管理员是一种特殊角色，适合运营人员代理多个企业进行融资对接。**访问入口：`/company` 或 `/staff`（自动重定向）**

### 统一企业门户
Staff 和 Company 角色使用同一个企业门户页面 (`/company/index.html`)，系统根据用户角色自动显示相应功能：

- **Company 角色**：只能管理自己的一个企业
- **Staff 角色**：可以创建和管理多个企业，页面顶部显示企业选择器

### Staff 角色特有功能

#### 1. 企业选择器
- 页面顶部显示企业下拉选择器
- 可以选择要管理的企业
- 切换企业时自动刷新所有相关数据

#### 2. 创建企业
- 点击"创建企业"按钮（仅 Staff 可见）
- 可以创建多个企业信息，无需该企业自己注册
- 创建时支持上传 BP 文件或填写 BP 链接

#### 3. 多企业管理
- 管理所有自己创建的企业
- 为每个企业上传 BP、填写融资信息
- 提交审核、管理资料库等

### 共同功能（Company 和 Staff 共享）

#### 1. 企业资料管理
- 填写/更新企业基本信息
- 所有字段均为可选（至少需要公司名称）

#### 2. 融资信息填写
- 填写融资需求详情
- 融资目的、类型、金额、时间窗口等

#### 3. BP/文档管理
- 上传多个 BP 文件或填写多个 BP 链接
- 查看、下载、删除已上传的文档

#### 4. 资料库管理
- 初始化资料库
- 管理文件夹和文件
- 查看投资人参与度统计
- 与投资人私密对话

#### 5. 提交审核
- 将企业提交给超级管理员审核
- 提交后仍可继续编辑（draft 和 pending 状态）

### API 端点

#### 统一企业 API（`/api/company/*`）
- `GET /api/company/companies` - 获取企业列表（仅 Staff）
- `GET /api/company/profile?companyId=xxx` - 获取企业信息（Staff 通过 companyId 参数）
- `POST /api/company/profile` - 创建/更新企业（Staff 通过 companyId 参数）
- `POST /api/company/fundraising` - 保存融资信息（Staff 通过 companyId 参数）
- `POST /api/company/upload-bp` - 上传 BP 文件（Staff 通过 companyId 参数）
- `POST /api/company/bp-link` - 保存 BP 链接（Staff 通过 companyId 参数）
- `POST /api/company/submit` - 提交审核（Staff 通过 companyId 参数）

#### Staff 专用 API（`/api/staff/*`）
- `GET /api/staff/stats` - 获取统计数据
- `POST /api/staff/companies` - 创建新企业
- `GET /api/staff/requests` - 获取访问请求
- `GET /api/staff/investors` - 获取投资人列表
- `POST /api/staff/messages` - 发送消息
- `GET /api/staff/messages/sent` - 获取已发送消息

## 数据模型

### 用户 (User)
- 支持四种角色：company, investor, staff, admin
- 密码使用 bcrypt 加密存储
- 状态：pending, active, suspended

### 企业 (Company)
- 包含基本信息、行业、阶段、联系人等
- 状态：draft, pending, approved, rejected
- 可见性：private, investors, whitelist

### 融资信息 (FundraisingInfo)
- 关联企业
- 包含融资目的、类型、金额、时间窗口等

### 文档 (Document)
- 支持 BP、财务、法律等类型文件
- 文件内容存储在数据库中（Base64编码）
- 支持访问控制

### 投资人资料 (InvestorProfile)
- 包含投资人信息和投资偏好
- 需要管理员审核后才能浏览项目

### 访问请求 (AccessRequest)
- 投资人向企业发起的 BP 访问或引荐请求
- 由管理员处理

### 消息 (Message)
- 管理员发送给用户的消息
- 支持附件（存储为Base64）
- 记录邮件发送状态
- 可关联状态变更操作

### 资料库 (Data Room) - 新增

#### DataRoomFolder - 资料库文件夹
- 预设类型：财务(financial)、法律(legal)、知识产权(ip)、股权结构(equity)、团队(team)、其他(other)
- 访问层级：概览(overview)、NDA签署后(nda)、全面尽职调查(full_dd)
- 支持自定义文件夹

#### DataRoomFile - 资料库文件
- 支持文件上传（Base64存储）和外部链接
- 支持版本控制
- 下载统计

#### DataRoomAccess - 资料库访问权限
- 投资人/Staff 对特定公司资料库的访问控制
- 支持 NDA 签署状态追踪
- 权限层级：overview → nda → full_dd

#### DataRoomMessage - 资料库私密对话
- 投资人与公司的一对一私密交流
- 投资人之间互相不可见
- 支持关联特定文件的讨论

#### DataRoomViewLog - 查看记录
- 追踪投资人查看行为
- 记录文件夹/文件访问、下载等操作
- 便于分析投资人参与度

### 兴趣表达 (InterestExpression) - 新增
- 投资人对企业的兴趣表达记录
- 兴趣类型：general（一般）、high（高度）、watching（持续关注）
- 支持管理员跟进备注

## 资料库功能说明

### 功能概述
资料库（Data Room）是一个安全的尽职调查资料共享系统，允许企业或Staff上传敏感的尽职调查材料，并由管理员精细控制投资人的访问权限。

### 文件夹结构
系统预设6个标准文件夹：
1. **财务资料** (Financials) - 财务报表、审计报告等
2. **法律文件** (Legal) - 合同、协议、法律意见书等
3. **知识产权** (IP) - 专利、商标、著作权等
4. **股权结构** (Equity Structure) - Cap Table、股东协议等
5. **团队资料** (Team) - 团队介绍、简历等
6. **其他资料** (Other) - 其他补充材料

### 权限层级
三级权限控制体系：

| 层级 | 名称 | 说明 |
|------|------|------|
| Level 1 | **概览 (Overview)** | 基础信息，可查看文件列表但无法下载敏感文件 |
| Level 2 | **NDA签署后 (Post-NDA)** | 签署保密协议后，可访问更多详细资料 |
| Level 3 | **全面尽职调查 (Full DD)** | 完整访问权限，可查看所有资料 |

### 查看追踪
- 记录每个投资人的查看行为
- 统计文件夹/文件访问次数
- 追踪下载记录
- 分析投资人参与深度

### 私密对话
- 投资人可直接与公司交流
- 每个投资人的对话相互独立、不可见
- 支持针对特定文件的讨论
- 消息通知（邮件）

### 资料库 API

#### 企业/Staff 端
- `POST /api/dataroom/companies/:id/init` - 初始化资料库
- `GET /api/dataroom/companies/:id/folders` - 获取文件夹列表
- `POST /api/dataroom/companies/:id/folders` - 创建自定义文件夹
- `PUT /api/dataroom/folders/:id` - 更新文件夹
- `POST /api/dataroom/folders/:folderId/files` - 上传文件
- `POST /api/dataroom/folders/:folderId/links` - 添加外部链接
- `DELETE /api/dataroom/files/:id` - 删除文件
- `GET /api/dataroom/companies/:id/analytics` - 查看统计
- `GET /api/dataroom/companies/:id/conversations` - 获取对话列表
- `GET /api/dataroom/companies/:companyId/conversations/:investorId` - 获取特定对话

#### 权限管理
- `GET /api/dataroom/companies/:id/access` - 获取访问权限列表
- `POST /api/dataroom/companies/:id/access` - 授予/更新权限
- `DELETE /api/dataroom/companies/:id/access/:userId` - 撤销权限
- `PUT /api/dataroom/companies/:id/access/:userId/nda` - 更新NDA状态

#### 投资人端
- `GET /api/dataroom/files/:id/download` - 下载文件
- `POST /api/dataroom/companies/:companyId/conversations/:investorId` - 发送消息

## 投资人功能增强

### 项目筛选
投资人可按以下条件筛选项目：
- **行业** - 主行业/次行业
- **阶段** - 种子轮到Post-IPO
- **投资规模** - 最小/最大融资金额
- **SG准备状态** - not_ready（未准备）、in_progress（进行中）、ready（已准备）
- **交易状态** - new（新项目）、dd（尽职调查中）、term_sheet（条款清单阶段）
- **关键词搜索** - 公司名称、简介

### 交易状态标签
| 状态 | 说明 |
|------|------|
| **new** | 新项目 - 刚上架或刚开始接触投资人 |
| **dd** | 尽职调查中 - 有投资人正在进行尽职调查 |
| **term_sheet** | 条款清单 - 已进入条款谈判阶段 |
| **closed** | 已关闭 - 融资完成或项目关闭 |

### 表达兴趣
投资人可对感兴趣的项目"表达兴趣"：
- 三种兴趣级别：一般关注、高度关注、持续关注
- 可附带留言
- 系统自动通知公司和管理员
- 管理员可跟进处理

### 投资人 API 增强
- `POST /api/investor/projects/:id/interest` - 表达兴趣
- `DELETE /api/investor/projects/:id/interest` - 撤回兴趣
- `GET /api/investor/my-interests` - 我的兴趣列表
- `GET /api/investor/my-dataroom-access` - 我的资料库访问权限

## 邮件服务配置

系统支持两种邮件发送方式：**Resend**（推荐）和 **SMTP**。

### 方式一：Resend（推荐）

Resend 是一个现代化的邮件发送服务，配置简单，送达率高。

```
RESEND_API_KEY=re_xxxxxxxxxxxx    # Resend API 密钥
EMAIL_FROM=EON Protocol <noreply@eon-protocol.com>  # 发件人（可选）
```

**获取 API Key：**
1. 访问 [resend.com](https://resend.com) 注册账号
2. 在 Dashboard 中创建 API Key
3. 在 Railway 环境变量中添加 `RESEND_API_KEY`

**注意事项：**
- Resend 免费套餐每月可发送 3000 封邮件
- 需要验证发件域名才能使用自定义发件地址
- 未验证域名时可使用 `onboarding@resend.dev` 作为发件人

### 方式二：SMTP

传统 SMTP 方式，支持任意 SMTP 服务器：

```
SMTP_HOST=smtp.gmail.com      # Gmail 示例
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password   # Gmail 需要使用应用专用密码
SMTP_FROM=EON Protocol <noreply@eon-protocol.com>
SMTP_SECURE=false             # 如果使用 465 端口，设置为 true
```

**常用 SMTP 服务：**
- Gmail: smtp.gmail.com (端口 587)
- SendGrid: smtp.sendgrid.net (端口 587)
- AWS SES: email-smtp.{region}.amazonaws.com
- 阿里云邮件: smtpdm.aliyun.com

### 邮件通知功能

配置邮件服务后，系统会在以下场景自动发送邮件通知：

#### 企业相关通知
1. **企业提交审核** - 企业/Staff 提交公司审核时，通知所有管理员
2. **审核结果通知 (ENGAGE/EXPLORE/PASS)** - 管理员审核企业后，通知：
   - 企业联系人
   - 所有管理员（排除操作者）
   - 有权限的 Staff
   - 企业创建者（如果是 Staff 创建的）

#### 反馈交流通知
3. **外部反馈 (Feedback to Company)** - 发送反馈时，通知：
   - 企业联系人
   - 所有管理员（排除操作者）
   - 有权限的 Staff
   - 企业创建者

4. **内部评论 (Internal Notes)** - 发送内部评论时，通知：
   - 所有管理员（排除操作者）
   - 有权限的 Staff
   - 企业创建者（如果是 Staff 创建的）
   - ⚠️ 不通知企业（内部评论仅内部可见）

#### 其他通知
5. **投资人审核结果通知** - 投资人账户审核通过/拒绝时，自动通知投资人
6. **访问请求处理通知** - 投资人的访问请求被处理时，自动通知投资人
7. **管理员消息通知** - 管理员发送消息时，可选择同时发送邮件通知

## 安全注意事项

1. **修改默认管理员密码** - 首次登录后立即修改
2. **设置强 JWT_SECRET** - 使用随机生成的长字符串
3. **启用 HTTPS** - Railway 默认提供 HTTPS
4. **定期备份数据库** - 在 Railway 控制台设置自动备份
5. **监控异常登录行为** - 检查日志中的异常登录尝试
6. **保护 SMTP 凭据** - 不要在代码中硬编码邮件密码

## 故障排除

### 数据库连接失败
- 检查 `DATABASE_URL` 环境变量是否正确
- 确认 PostgreSQL 服务正在运行

### 邮件发送失败
- 检查 SMTP 配置是否正确
- Gmail 用户需要启用"低安全性应用访问"或使用应用专用密码
- 检查防火墙是否允许 SMTP 端口

### 文件上传失败
- **Railway 平台限制**：由于 Railway 平台的请求超时限制，大文件上传可能会失败
- 当前限制：文件大小不超过 **2MB**
- 如果文件较大，建议：
  1. 压缩 PDF 文件（使用在线工具如 smallpdf.com）
  2. 将 PPT 导出为压缩 PDF
  3. 删除文档中的高分辨率图片
- 检查文件格式是否支持（PDF, PPT, PPTX, DOC, DOCX）

#### 大文件解决方案（未来）
对于需要支持更大文件的场景，建议：
1. 使用云存储服务（如 AWS S3、Cloudflare R2）进行直接上传
2. 将文件 URL 存储在数据库中，而不是文件内容本身
3. 或者迁移到支持更长请求超时的托管平台

### 登录问题
- 清除浏览器缓存和 localStorage
- 检查 JWT_SECRET 是否正确配置

### 管理员账户无法登录
系统在每次启动时会自动创建/更新管理员账户，检查以下内容：

1. **检查环境变量**
   - 确认 `ADMIN_EMAIL` 和 `ADMIN_PASSWORD` 在 Railway 中正确设置
   - 示例：`ADMIN_EMAIL=admin@eon-protocol.com`
   - 示例：`ADMIN_PASSWORD=your-secure-password`

2. **查看启动日志**
   在 Railway 的日志中查看以下信息：
   ```
   [Server] 检查管理员账户: admin@eon-protocol.com
   [Server] 管理员登录验证: 成功
   ```
   
   如果看到 `管理员登录验证: 失败`，系统会自动强制更新密码。

3. **数据库同步问题**
   如果看到 `[Database] 数据库同步失败` 错误，可能需要：
   - 检查 `DATABASE_URL` 是否正确
   - 确认数据库服务正在运行
   - 尝试手动运行初始化脚本：`railway run npm run init-db`

4. **重置管理员密码**
   如果仍然无法登录，可以通过以下方式重置：
   - 更改 `ADMIN_PASSWORD` 环境变量为新密码
   - 重启应用（系统会自动检测并更新密码）
   
5. **手动创建管理员**
   如果自动创建失败，可以通过数据库直接创建：
   ```sql
   -- 连接到 PostgreSQL 后运行
   -- 注意：密码需要先用 bcrypt 加密
   INSERT INTO users (id, email, password, role, status, name, created_at, updated_at)
   VALUES (
       gen_random_uuid(),
       'admin@eon-protocol.com',
       '$2a$10$...', -- bcrypt 加密后的密码
       'admin',
       'active',
       'Administrator',
       NOW(),
       NOW()
   );
   ```
